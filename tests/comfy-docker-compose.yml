version: "3.8"

services:
  selenium:
    container_name: ${SELENIUM_CONTAINER_NAME}
    image: ${ACR_ORG}/${SELENIUM_IMAGE}
    network_mode: host
    shm_size: 2g
    command: sleep 5400
    entrypoint: /opt/bin/entry_point.sh
    restart: "no"

  onediff-test:
    container_name: ${CONTAINER_NAME}
    image: ${ACR_ORG}/${MATRIX_IMAGE}
    command: sleep 5400
    privileged: true
    shm_size: 8g
    network_mode: host
    pids_limit: 2000
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
    environment:
      ONEFLOW_RUN_GRAPH_BY_VM: "0"
      HF_HUB_OFFLINE: "1"
      ONEFLOW_MLIR_ENABLE_TIMING: "1"
      ONEFLOW_MLIR_PRINT_STATS: "1"
      CI: "1"
      SILICON_ONEDIFF_LICENSE_KEY: ${SILICON_ONEDIFF_LICENSE_KEY}
    volumes:
      - $HOME/test-container-cache-${CONTAINER_NAME}/dot-local:/root/.local
      - $HOME/test-container-cache-${CONTAINER_NAME}/dot-cache:/root/.cache
      - /share_nfs:/share_nfs:ro
      - ${PWD}/${COMFYUI_SRC_DIR}:/app/ComfyUI
      - ${PWD}/onediff_comfy_nodes:/app/ComfyUI/custom_nodes/onediff_comfy_nodes
      - $PWD:/src/onediff
    working_dir: /src/onediff
    restart: "no"
    depends_on:
      - selenium
